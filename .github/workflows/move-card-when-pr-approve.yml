name: Move Jira Card

on:
  repository_dispatch:
    types: [MOVE_CARD]

permissions:
  contents: read
  pull-requests: read  # Permissão para ler pull requests

jobs:
  check-prs:
    runs-on: ubuntu-latest
    steps:
      - name: Check PRs in Frontend Repository
        id: check_frontend_prs
        run: |
          echo "Checking open PRs in frontend repository..."
          FRONTEND_REPO="LOL-Graphics-WEB"
          ORG_NAME="lolgraphics"
          BRANCH_NAME="${{ github.event.client_payload.issue_key }}"
          
          # Encontrar PRs que mencionam a branch no corpo e estão abertos
          PR_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/$ORG_NAME/$FRONTEND_REPO/pulls?state=open")

          # Verificar se a branch está mencionada em algum PR
          OPEN_PR=$(echo "$PR_RESPONSE" | jq --arg BRANCH_NAME "$BRANCH_NAME" \
            '.[] | select(.body | contains($BRANCH_NAME)) | .number')

          if [ -z "$OPEN_PR" ]; then
            echo "No open PRs found with branch name $BRANCH_NAME in frontend repository."
            echo "frontend_pr_open=0" >> $GITHUB_ENV
          else
            echo "Open PRs found with branch name $BRANCH_NAME in frontend repository."
            echo "frontend_pr_open=1" >> $GITHUB_ENV
          fi
          
      - name: Move Jira Card
        if: ${{ env.frontend_pr_open == '0' && env.backend_pr_open == '0' }}
        env:
          JIRA_URL: ${{ secrets.JIRA_URL }}
          JIRA_USERNAME: ${{ secrets.JIRA_USERNAME }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          ISSUE_KEY: ${{ github.event.client_payload.issue_key }}
          TRANSITION_ID: ${{ github.event.client_payload.transition_id }}
        run: |
          set -e  # Fail on any error

          # Obter as transições possíveis para o issue
          response=$(curl -s -w "\n%{http_code}" -u $JIRA_USERNAME:$JIRA_API_TOKEN \
            -X GET \
            -H "Accept: application/json" \
            $JIRA_URL/rest/api/3/issue/$ISSUE_KEY/transitions)
          
          body=$(echo "$response" | head -n -1)
          http_code=$(echo "$response" | tail -n1)
          
          echo "HTTP status code: $http_code"
          echo "Transições disponíveis: $body"
          
          if [ "$http_code" -ne 200 ]; then
            echo "Failed to get transitions. HTTP status code: $http_code. Exiting."
            exit 1
          fi
          
          # Realizar a transição para o status desejado
          response=$(curl -s -w "\n%{http_code}" -u $JIRA_USERNAME:$JIRA_API_TOKEN \
            -X POST \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            --data '{"transition": {"id": "'$TRANSITION_ID'"}}' \
            $JIRA_URL/rest/api/3/issue/$ISSUE_KEY/transitions)
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          echo "HTTP status code: $http_code"
          echo "Response body: $body"
          
          if [ "$http_code" -ne 204 ]; then
            echo "Failed to transition issue. HTTP status code: $http_code. Response body: $body. Exiting."
            exit 1
          fi
